<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cashflow</title>
  <style>
    :root{--bg:#0b1020;--panel:#121a34;--card:#0f1530;--acc:#2d6df6;--text:#e8ecff;--muted:#a7b0d6;--danger:#ff5d5d;--ok:#30d158}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:radial-gradient(1200px 800px at 20% -10%,#1a2455 0%,#0b1020 55%);color:var(--text)}
    .wrap{max-width:1100px;margin:auto;padding:16px;display:grid;gap:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{font-size:clamp(18px,3vw,26px);margin:0;letter-spacing:.2px}
    header .actions{display:flex;gap:8px;flex-wrap:wrap}
    button,.btn{appearance:none;border:0;cursor:pointer;border-radius:14px;padding:10px 14px;background:var(--acc);color:white;font-weight:600;box-shadow:0 4px 14px rgba(45,109,246,.35);transition:transform .05s ease,filter .2s ease,background .2s ease}
    button:active{transform:translateY(1px)}
    .btn-secondary{background:#1e2a57;color:var(--text);box-shadow:0 4px 14px rgba(0,0,0,.25)}
    .btn-danger{background:var(--danger)}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 360px}}
    .players{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
    .player{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0));border:1px solid rgba(255,255,255,.06);border-radius:18px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.35)}
    .p-header{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:10px}
    .p-name{font-weight:700;font-size:22px;outline:none;border:none;background:transparent;color:var(--text);border-bottom:1px dashed transparent}
    .p-name[contenteditable="true"]:focus{border-color:#3a4b9a}
    .balance{font-feature-settings:"tnum" 1;letter-spacing:.3px;font-size:24px;font-weight:800}
    .controls{display:flex;gap:8px;margin-top:12px}
    .controls button{flex:1;padding:12px 10px;font-size:24px;border-radius:12px;font-weight:700}
    .plus{background:linear-gradient(180deg,#3bb273,#23995c);box-shadow:0 6px 18px rgba(48,209,88,.35)}
    .minus{background:linear-gradient(180deg,#e05757,#c74444);box-shadow:0 6px 18px rgba(255,93,93,.35)}
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.02),transparent);border:1px solid rgba(255,255,255,.06);border-radius:18px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.35);position:sticky;top:10px}
    .display{display:flex;align-items:baseline;justify-content:space-between;background:rgba(255,255,255,.04);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.08);margin-bottom:12px}
    .display .label{color:var(--muted);font-size:12px}
    .display .amount{font-size:28px;font-weight:800;font-feature-settings:"tnum" 1}
    .keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .keypad button{padding:14px 0;border-radius:12px;background:#1a244f;color:var(--text);font-size:18px;font-weight:700;box-shadow:0 4px 14px rgba(0,0,0,.25)}
    .keypad .wide{grid-column:span 2}
    .muted{color:var(--muted)}
    .row{display:flex;gap:8px;margin-top:8px}
    .chip{font-size:16px;padding:10px 14px;border-radius:999px;background:#1b2450;color:#c8d0ff;border:1px solid rgba(255,255,255,.06);cursor:pointer;font-weight:600}
    .chip:active{transform:translateY(1px)}
    .footer{opacity:.7;text-align:center;font-size:12px;margin-top:6px}
    .test-status{margin-top:8px;text-align:center;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Cashflow</h1>
      <div class="actions">
        <button class="btn-secondary" id="addPlayer">Add Player</button>
        <button class="btn-secondary" id="resetAmounts">Reset Amount</button>
        <button class="btn-danger" id="resetAll">Reset All</button>
      </div>
    </header>

    <div class="grid">
      <section>
        <div class="players" id="players"></div>
      </section>

      <aside class="panel">
        <div class="display">
          <div>
            <div class="label">Amount Ready</div>
            <div id="amount" class="amount">$0.00</div>
          </div>
          <div class="muted" id="centsInfo"></div>
        </div>

        <div class="keypad" id="keypad"></div>

        <div class="row">
          <div class="chip" data-preset="100">+ $100</div>
          <div class="chip" data-preset="50">+ $50</div>
          <div class="chip" data-preset="20">+ $20</div>
          <div class="chip" data-preset="10">+ $10</div>
        </div>
        <div class="row">
          <div class="chip" data-preset="-100">- $100</div>
          <div class="chip" data-preset="-50">- $50</div>
          <div class="chip" data-preset="-20">- $20</div>
          <div class="chip" data-preset="-10">- $10</div>
        </div>
        <div class="footer">Tip: You can also type on the keyboard. Enter = apply to last player (add).</div>
        <div class="test-status" id="testStatus">Self-tests running…</div>
      </aside>
    </div>
  </div>

  <script>
    // --- Defensive: this app has NULL Web3/MetaMask dependencies.
    // If another script in your environment tries to connect to MetaMask and fails,
    // we ensure it doesn't stop the app:
    window.addEventListener('error', (e)=>{
      if(String(e?.message||'').includes('MetaMask')){
        console.warn('Ignoring external MetaMask error for this app:', e.message);
        e.preventDefault?.();
      }
    });
    window.addEventListener('unhandledrejection', (e)=>{
      const msg = String(e?.reason?.message||e?.reason||'');
      if(msg.includes('MetaMask')){
        console.warn('Ignoring external MetaMask promise error:', msg);
        e.preventDefault?.();
      }
    });

    // --- Money utils (stores as cents for precision) ---
    function toCents(str){
      if(str === null || str === undefined) return 0;
      str = String(str).trim();
      if(!str) return 0;
      // Remove currency/space, keep minus and decimal
      let sign = 1;
      if(str.startsWith('-')){ sign = -1; str = str.slice(1); }
      str = str.replace(/[^0-9.]/g,'');
      if(!str) return 0;
      const parts = str.split('.');
      let dollars = parts[0].replace(/\D/g,'') || '0';
      let cents = (parts[1] || '').slice(0,2).padEnd(2,'0');
      const val = sign * (parseInt(dollars,10)*100 + parseInt(cents||'0',10));
      return isNaN(val) ? 0 : val;
    }
    function fmt(cents){
      const sign = cents < 0 ? '-' : '';
      const abs = Math.abs(cents|0);
      const d = Math.floor(abs/100);
      const c = String(abs%100).padStart(2,'0');
      return sign + '$' + d.toLocaleString('en-US') + '.' + c;
    }

    // Clean, testable operation
    function applyOp(balanceCents, op, amountCents){
      if(!amountCents) return balanceCents|0;
      return (op === '+') ? (balanceCents|0) + amountCents : (balanceCents|0) - amountCents;
    }

    // --- State ---
    const MAX_PLAYERS = 6;
    const defaultPlayers = [
      { name: 'Player 1', balance: 0 },
      { name: 'Player 2', balance: 0 },
    ];
    let players = JSON.parse(localStorage.getItem('players_v1')||'null') || defaultPlayers;
    if(players.length > MAX_PLAYERS) players = players.slice(0, MAX_PLAYERS);
    let currentAmountStr = '';
    let lastTargetIndex = 0; // for Enter shortcut

    const $players = document.getElementById('players');
    const $amount = document.getElementById('amount');
    const $centsInfo = document.getElementById('centsInfo');

    // --- Render ---
    function renderPlayers(){
      $players.innerHTML = '';
      players.forEach((p,idx)=>{
        const card = document.createElement('div');
        card.className = 'player';
        card.innerHTML = `
          <div class="p-header">
            <div class="p-name" contenteditable="true" data-idx="${idx}" spellcheck="false">${p.name}</div>
            <div class="balance">${fmt(p.balance)}</div>
          </div>
          <div class="controls">
            <button class="minus" data-idx="${idx}" data-op="-">−</button>
            <button class="plus" data-idx="${idx}" data-op="+">+</button>
          </div>`;
        $players.appendChild(card);
      });
    }

    function save(){ localStorage.setItem('players_v1', JSON.stringify(players)); }

    function setAmountStr(str){
      currentAmountStr = str;
      const cents = toCents(str);
      $amount.textContent = fmt(cents);
      $centsInfo.textContent = cents ? `${cents}¢` : '';
    }

    function appendToAmount(ch){ setAmountStr((currentAmountStr||'') + ch); }
    function backspace(){ setAmountStr((currentAmountStr||'').slice(0,-1)); }
    function clearAmount(){ setAmountStr(''); }

    function applyTo(idx, op){
      const cents = toCents(currentAmountStr);
      if(!cents) return; // ignore 0
      lastTargetIndex = idx;
      players[idx].balance = applyOp(players[idx].balance, op, cents);
      save();
      renderPlayers();
      clearAmount();
    }

    // --- Init keypad ---
    const keypadLayout = ["7","8","9","4","5","6","1","2","3",".","0","⌫","C"];
    const $keypad = document.getElementById('keypad');
    keypadLayout.forEach(k=>{
      const b = document.createElement('button');
      b.textContent = k;
      if(k === 'C') b.classList.add('wide');
      b.addEventListener('click', ()=>{
        if(k === '⌫'){ backspace(); }
        else if(k === 'C'){ clearAmount(); }
        else { appendToAmount(k); }
      });
      $keypad.appendChild(b);
    });

    // --- Chips ---
    document.querySelectorAll('.chip').forEach(ch=>{
      ch.addEventListener('click', ()=>{
        const val = parseInt(ch.dataset.preset,10);
        const cur = toCents(currentAmountStr);
        const next = cur + (val*100);
        setAmountStr(String(next/100));
      });
    });

    // --- Delegated events ---
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      if(btn.matches('.plus,.minus')){
        const idx = parseInt(btn.dataset.idx,10);
        const op = btn.dataset.op;
        applyTo(idx, op);
      }
    });

    // Editable names
    document.addEventListener('blur', (e)=>{
      const el = e.target;
      if(el.classList && el.classList.contains('p-name')){
        const idx = parseInt(el.dataset.idx,10);
        players[idx].name = el.textContent.trim() || `Player ${idx+1}`;
        save();
      }
    }, true);

    // Keyboard shortcuts
    document.addEventListener('keydown', (e)=>{
      // numbers and decimal
      if(/^[0-9]$/.test(e.key) || e.key === '.'){ appendToAmount(e.key); return; }
      if(e.key === 'Backspace'){ backspace(); return; }
      if(e.key.toLowerCase() === 'c'){ clearAmount(); return; }
      if(e.key === 'Enter'){ applyTo(lastTargetIndex, '+'); return; }
      if(e.key === '-'){ applyTo(lastTargetIndex, '-'); return; }
    });

    // Header buttons
    document.getElementById('addPlayer').addEventListener('click', ()=>{
      if(players.length >= MAX_PLAYERS) return alert('Maximum 6 players');
      players.push({ name: `Player ${players.length+1}`, balance: 0 });
      save();
      renderPlayers();
    });

    document.getElementById('resetAmounts').addEventListener('click', ()=> clearAmount());

    document.getElementById('resetAll').addEventListener('click', ()=>{
      if(confirm('Reset names and balances for all and set 2 players?')){
        players = defaultPlayers.map(p=>({...p}));
        save();
        renderPlayers();
        clearAmount();
      }
    });

    // --- Self-tests ---
    function runTests(){
      const results = [];
      function t(name, fn){
        try{ fn(); results.push({name, ok:true}); }
        catch(err){ console.error('Test failed:', name, err); results.push({name, ok:false, err}); }
      }
      // toCents
      t('toCents("0") == 0', ()=>{ if(toCents('0')!==0) throw new Error(); });
      t('toCents("12") == 1200', ()=>{ if(toCents('12')!==1200) throw new Error(); });
      t('toCents("12.3") == 1230', ()=>{ if(toCents('12.3')!==1230) throw new Error(); });
      t('toCents("12.34") == 1234', ()=>{ if(toCents('12.34')!==1234) throw new Error(); });
      t('toCents("$1,234.56") == 123456', ()=>{ if(toCents('$1,234.56')!==123456) throw new Error(); });
      t('toCents("-7.05") == -705', ()=>{ if(toCents('-7.05')!==-705) throw new Error(); });
      // fmt
      t('fmt(0) == $0.00', ()=>{ if(fmt(0) !== '$0.00') throw new Error(fmt(0)); });
      t('fmt(1234) == $12.34', ()=>{ if(fmt(1234) !== '$12.34') throw new Error(fmt(1234)); });
      t('fmt(-705) == -$7.05', ()=>{ if(fmt(-705) !== '-$7.05') throw new Error(fmt(-705)); });
      // applyOp
      t('applyOp(1000,"+",250) == 1250', ()=>{ if(applyOp(1000,'+',250)!==1250) throw new Error(); });
      t('applyOp(1000,"-",250) == 750', ()=>{ if(applyOp(1000,'-',250)!==750) throw new Error(); });
      t('applyOp(0,"+",0) == 0', ()=>{ if(applyOp(0,'+',0)!==0) throw new Error(); });
      // Integration: simulate add/subtract
      const tmp = [{name:'A', balance:0},{name:'B', balance:5000}];
      let bal = tmp[1].balance; bal = applyOp(bal,'-',toCents('20')); if(bal!==4800) throw new Error('subtract integration');
      bal = applyOp(bal,'+',toCents('0.50')); if(bal!==4850) throw new Error('add integration');

      const ok = results.every(r=>r.ok);
      const $status = document.getElementById('testStatus');
      if(ok){ $status.textContent = `Self-tests: ${results.length}/${results.length} passed ✓`; $status.style.color = 'var(--ok)'; }
      else { $status.textContent = `Self-tests: ${results.filter(r=>r.ok).length}/${results.length} passed – check console`; $status.style.color = 'var(--danger)'; }
      return ok;
    }

    // Boot
    renderPlayers();
    setAmountStr('');
    runTests();
  </script>
</body>
</html>